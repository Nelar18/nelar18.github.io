<script>
(function(){
  const carousel = document.getElementById('carousel');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  function getGapPx(){
    const style = getComputedStyle(carousel);
    const gap = style.gap || style.columnGap || '20px';
    return parseFloat(gap);
  }

  function computeStep(){
    const first = carousel.querySelector('.project-card');
    if(!first) return 300;
    const rect = first.getBoundingClientRect();
    const gap = getGapPx();
    return Math.round(rect.width + gap);
  }

  function updateButtons(){
    // En modo “wrapeable” nunca se deshabilitan los botones
    btnPrev.disabled = false;
    btnNext.disabled = false;
  }

  function scrollStep(direction = 1){
    const step = computeStep();
    const vw = window.innerWidth;
    let visible = 3;
    if(vw <= 620) visible = 1;
    else if(vw <= 960) visible = 2;

    const distance = step * visible * direction;
    const maxScroll = Math.max(0, carousel.scrollWidth - carousel.clientWidth);
    const nextScroll = carousel.scrollLeft + distance;

    // Si llegamos al final o al principio, hacemos “wrap”
    if (nextScroll > maxScroll + 10) {
      carousel.scrollTo({ left: 0, behavior: 'smooth' });
    } else if (nextScroll < -10) {
      carousel.scrollTo({ left: maxScroll, behavior: 'smooth' });
    } else {
      const target = Math.min(Math.max(0, nextScroll), maxScroll);
      carousel.scrollTo({ left: target, behavior: 'smooth' });
    }
  }

  btnNext.addEventListener('click', () => scrollStep(1));
  btnPrev.addEventListener('click', () => scrollStep(-1));

  let isScrolling;
  carousel.addEventListener('scroll', () => {
    window.requestAnimationFrame(updateButtons);
    clearTimeout(isScrolling);
    isScrolling = setTimeout(() => {
      const step = computeStep();
      if(step <= 0) return;
      const current = carousel.scrollLeft;
      const nearest = Math.round(current / step) * step;
      carousel.scrollTo({ left: nearest, behavior: 'smooth' });
    }, 150);
  });

  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateButtons, 120);
  });

  setTimeout(() => {
    updateButtons();
    carousel.tabIndex = 0;
    carousel.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowRight'){ e.preventDefault(); scrollStep(1); }
      if(e.key === 'ArrowLeft'){ e.preventDefault(); scrollStep(-1); }
    });
  }, 120);
})();
</script>
